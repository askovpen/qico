# 
# $Id: Makefile.in,v 1.13 2001/03/20 15:02:34 lev Exp $
#

prefix  = @prefix@
exec_prefix = @exec_prefix@
BINDIR  = @bindir@
SBINDIR  = @sbindir@

CC      = @CC@
AWK     = @AWK@
INSTALL = @INSTALL@
LEX     = @LEX@
YACC    = @YACC@

QCC     = @QCC@

LIBOBJS= @LIBOBJS@

NEWZMODEM = @NEWZMODEM@

#DEFS   += -DY_DEBUG #-DYYERROR_VERBOSE=1 -DYYDEBUG=100

DEFS    += -DQIPC_KEY=\"$(SBINDIR)/qico\" -I. -I..

CFLAGS	= $(DEFS) -Wall -D_GNU_SOURCE=1 -D_BSD_SOURCE=1
LFLAGS  += @LIBS@
CFLAGS  += @CFLAGS@

LIBS    += @LIBS@
QCLIBS  = @QCCLIBS@

OBJS	= ftn.o nodelist.o main.o config.o bso.o log.o ver.o queue.o qconf.o \
          tty.o globals.o emsi.o crc.o session.o call.o qnlc.o qipc.o tcp.o \
          hydra.o flagexp.o execsh.o protfm.o janus.o freq.o gmtoff.o xmem.o $(LIBOBJS)


QCCOBJS	= qcc.o ver.o
QCTLOBJS= qctl.o ver.o gmtoff.o $(LIBOBJS)

LIBSRCS=$(LIBOBJS:.o=.c)

SRCS    = ftn.c nodelist.c main.c config.c bso.c log.c queue.c \
          tty.c globals.c emsi.c crc.c session.c call.c qnlc.c qipc.c tcp.c \
          hydra.c execsh.c protfm.c janus.c freq.c gmtoff.c xmem.c $(LIBSRCS)

ifeq (1,$(NEWZMODEM))
OBJS    += ls_zmodem.o ls_zglue.o ls_zreceive.o ls_zsend.o
SRCS    += ls_zmodem.c ls_zglue.c ls_zreceive.c ls_zsend.c
else
OBJS    += zm.o zmr.o zrecv.o zsend.o
SRCS    += zm.c zmr.c zrecv.c zsend.c
endif

AUTOH = qconf.h 
AUTOC = qconf.c flagexp.c flaglex.c
AUTOALL = ver.c Makefile

.c.o:
	$(CC) -c $(CFLAGS) -o $*.o $< 

###############################################################################
ifeq (1,$(QCC))
all:	qico qcc qctl
else
all:	qico qctl
endif

qico:	$(OBJS) 
	$(CC) $(CFLAGS) -o qico $(OBJS) $(LIBS)

qcc:	$(QCCOBJS)
	$(CC) $(CFLAGS) -o qcc $(QCCOBJS) $(QCLIBS) $(LIBS)

qctl:	$(QCTLOBJS)
	$(CC) $(CFLAGS) -o qctl $(QCTLOBJS) $(DLIBS)

qconf.c: qconf.x qconf.h
	$(AWK) -F, -f x2c.awk qconf.x > qconf.c

qconf.h: qconf.x
	$(AWK) -F, -f x2h.awk qconf.x > qconf.h

flaglex.c: flaglex.l
	$(LEX) flaglex.l
	mv -f lex.yy.c flaglex.c

flagexp.c: flagexp.y flaglex.c
	$(YACC) flagexp.y
	mv -f y.tab.c flagexp.c

Makefile: ../config.status Makefile.in
	cd .. && ./config.status

*.c:	../config.h

$(SRCS): $(AUTOH)

$(OBJS) $(QCCOBJS) $(QCTLOBJS): Makefile ../config.h

ifeq (1,$(QCC))
install: install-qico install-qcc install-qctl
install-strip: install-qico-strip install-qcc-strip install-qctl-strip
else
install: install-qico install-qctl
install-strip: install-qico-strip install-qctl-strip
endif

install-qico: qico
	$(INSTALL) -m 755 qico $(SBINDIR)
install-qcc: qcc
	$(INSTALL) -m 755 qcc $(BINDIR)
install-qctl: qctl
	$(INSTALL) -m 755 qctl $(BINDIR)

install-qico-strip: qico
	$(INSTALL) -m 755 -s qico $(SBINDIR)
install-qcc-strip: qcc
	$(INSTALL) -m 755 -s qcc $(BINDIR)
install-qctl-strip: qctl
	$(INSTALL) -m 755 -s qctl $(BINDIR)

clean:
	rm -f *.o core qico qcc qctl $(AUTOH) $(AUTOC) *~

full-clean: clean
	rm -f $(AUTOALL)
